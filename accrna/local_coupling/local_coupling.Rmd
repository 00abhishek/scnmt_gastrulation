---
title: "Gastrulation: local correlation between DNA methylation and RNA expression"
output: 
  BiocStyle::html_document: 
    fig_width: 12
    fig_height: 8
---

```{r echo=FALSE, include=FALSE}
suppressPackageStartupMessages(library(scater))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(ggplot2))
```

<!-- Define functions -->
```{r definefuncs, echo=FALSE}
source("/Users/ricard/gastrulation/metacc/local_coupling/utils.R")
```

<!-- Define I/O and options -->
```{r define_opts, echo=FALSE, include=FALSE}

## Define I/O ##
io <- list()
if (grepl("ricard",Sys.info()['nodename'])) {
  io$basedir <- "/Users/ricard/data/gastrulation"
  io$outdir <- "/Users/ricard/gastrulation/accrna/local_coupling/out"
  io$tss <- "/Users/ricard/data/mm10_regulation/promoters/TSS.bed"
} else {
  stop()
}
io$in.sample_metadata <- paste0(io$basedir,"/sample_metadata_scNMT.txt")
io$acc.indir <- paste(io$basedir,"acc/raw",sep="/")
io$rna.infile <- paste(io$basedir,"rna/parsed/sceset_scNMT.rds",sep="/")

## Define options ##
opts <- list()

# Define stage and lineages
opts$stage_lineage <- c(
  "E4.5_EPI",#"E4.5_PE",
  "E5.5_EPI",#"E5.5_PE"
  "E6.5_EPI","E6.5_PS",#"E6.5_VE",
  "E7.5_Ectoderm","E7.5_Mesoderm"#"E7.5_Endoderm"
)

# Define window options
opts$up <- 2500
opts$window <- 150
opts$slide <- 50
opts$down <- 2500
```

<!-- Load gene metadata -->
```{r}
# All promoters
tss <- fread(io$tss,stringsAsFactors=TRUE)[,c(1,2,3,6,4)] %>%
  setnames(c("chr","start","end","strand","ens_id")) %>%
  .[,chr:=as.factor(sub("chr","",chr))] %>%
  .[,TSS:=start] %>%
  .[,c("start","end"):=.(as.integer(start-opts$up),as.integer(end+opts$down))] %>%
  setkey(chr,start,end)
```

<!-- Filter CGI and non-CGI promoters -->
```{r}
non_cgi_promoters <- fread("/Users/ricard/data/gastrulation/features/filt/prom_2000_0_noncgi.bed",stringsAsFactors=T)[,V5]
cgi_promoters <- fread("/Users/ricard/data/gastrulation/features/filt/prom_2000_0_cgi.bed",stringsAsFactors=T)[,V5]
tss <- tss[,type:=ifelse(ens_id%in%non_cgi_promoters,"non_cgi","cgi")] %>% .[,type:=as.factor(type)]

# tss <- tss[type=="non_cgi"]
```

<!-- Load sample metadata and define which cells to use -->
```{r}
sample_metadata <- fread(io$in.sample_metadata, stringsAsFactors=T) %>% 
  .[,stage_lineage:=paste(stage,lineage,sep="_")] %>%
  .[pass_accQC==T & pass_rnaQC==T & stage_lineage%in%opts$stage_lineage] %>%
  .[,c("sample","id_acc","id_rna","stage","lineage")]

opts$acc.cells <- sample_metadata$id_acc
opts$rna.cells <- sample_metadata$id_rna
```

<!-- Subset cells to reduce memory burden -->
```{r}
opts$ncells <- 15
opts$filt.cells <- sample_metadata[,head(unique(sample),n=opts$ncells), by="stage"] %>% .$V1

sample_metadata <- sample_metadata[sample %in% opts$filt.cells]
opts$acc.cells <- sample_metadata$id_acc
opts$rna.cells <- sample_metadata$id_rna
```

<!-- Load accessibility data -->
```{r}
acc_dt <- loadMultipleMetData(io$acc.indir, opts$acc.cells, tss) %>% 
  setnames("id_met","id_acc") %>%
  .[,type:=NULL]
```

<!-- Load RNA expression data -->
```{r}
# Load SCE object
sce <- readRDS(file=io$rna.infile)
sce <- sce[,colnames(sce) %in% opts$rna.cells]

# Convert to data.table
rna_dt <- exprs(sce) %>% t %>% as.data.table(keep.rownames = "id_rna") %>% 
  melt(id.vars = "id_rna", value.name = "expr", variable.name = "ens_id") %>%
  merge(rowData(sce) %>% as.data.frame(row.names = rownames(sce)) %>% tibble::rownames_to_column("ens_id") %>% .[,c("ens_id","symbol")] %>% setnames("symbol","gene"))
rna_dt[,c("ens_id","id_rna","gene"):=list(as.factor(ens_id),as.factor(id_rna),as.factor(gene))]
```

<!-- Merge data and sample metadata -->
```{r}
acc_dt <- acc_dt %>% merge(sample_metadata[,c("id_acc","sample","stage")], by="id_acc")
rna_dt <- rna_dt %>% merge(sample_metadata[,c("id_rna","sample","stage")], by="id_rna") %>%
  merge(tss[,c("ens_id","type")], by="ens_id")
```

<!-- Merge DNA accessibility and RNA expression data -->
```{r}
accrna_dt <- merge(acc_dt, rna_dt, by=c("sample","ens_id","stage")) %>% .[,c("id_acc","id_rna"):=NULL]
rm(acc_dt,rna_dt)
```

<!-- Filter data -->
```{r filter, echo=FALSE}
```

<!-- Overlap data with windows -->
```{r, echo=FALSE}
tmp <- seq(from=0-opts$up, to=0+opts$down-opts$window, by=opts$slide)
foo <- data.table(window_center=tmp+(opts$window/2), rel_start=tmp, rel_end=tmp+opts$window)

bar <- foverlaps(
    x = foo %>% setkey(rel_start,rel_end),
    y = accrna_dt[,c("rel_start","rel_end"):=dist ] %>% setkey(rel_start,rel_end),
    nomatch = 0
  ) %>%
  .[,c("i.rel_start","i.rel_end","rel_start","rel_end"):=NULL] %>%
  .[,.(rate=mean(rate), N=.N), by=c("sample","ens_id","gene","window_center","expr","stage")]
rm(tmp,foo,accrna_dt)
```

Permute gene expression labels
```{r}
bar %>% .[,expr:=sample(expr), by=c("sample")]
```

<!-- Compute local correlations -->
```{r}
cor <- bar %>% .[,.(r=cor(x=rate, y=expr, method="pearson", use="pairwise.complete.obs")), by=c("sample","window_center","stage")]
```

<!-- Plot -->
```{r}
p <- ggplot(cor,aes(x=window_center, y=r)) +
  stat_summary(aes(fill=stage, color=stage), fun.data=mean_sd, geom="smooth", alpha=0.2, size=1.0) +
  # stat_summary(aes(fill=interaction(stage,type), color=interaction(stage,type)), fun.data=mean_sd, geom="smooth", alpha=0.2, size=1.0) +
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.5) +
  geom_vline(xintercept=0, linetype="dashed", color="black", size=0.5) +
  ylab("Correlation") + xlab("Genomic distance from TSS (bp)") +
  scale_x_continuous(limits=c(-opts$up,opts$down)) +
  coord_cartesian(ylim=c(-0.25,0.25)) +
  scale_fill_discrete(guide=FALSE) +
  theme_pub()
print(p)

pdf(file=paste0(io$outdir,"/accrna_local_permuted.pdf"), width=6.5, height=5)
print(p)
dev.off()
```

