---
title: "Gastrulation: local coupling between DNA methylation and DNA accessibility in ESC"
output: 
  BiocStyle::html_document: 
    fig_width: 12
    fig_height: 8
---

```{r echo=FALSE, include=FALSE}
suppressPackageStartupMessages(library(scater))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(ggplot2))
```

<!-- Define functions -->
```{r definefuncs, echo=FALSE}
loadMultipleMetData <- function(indir, cells, annotation=NULL) {
  data_list <- list()
  for (cell in cells) {
    if (file.exists(sprintf("%s/%s.tsv.gz",indir,cell))) {
      # print(sprintf("Loading %s...",cell))
      data_list[[cell]] <- fread(sprintf("zcat < %s/%s.tsv.gz",indir,cell), sep="\t", stringsAsFactors=T) %>%
        setnames(c("chr","pos","rate")) %>%
        .[,sample:=cell] %>% .[,c("start","end"):=list(pos,pos)] %>% 
        setkey("chr","start","end") %>%
        foverlaps(annotation, nomatch=0) %>% 
        .[,dist:=ifelse(strand %in% c("+","*"),pos-TSS,TSS-pos)] %>% 
        .[,c("sample","ens_id","dist","rate")]
    }
  }
  return(rbindlist(data_list))
}
```

<!-- Define I/O and options -->
```{r define_opts, echo=FALSE, include=FALSE}

## Define I/O ##
io <- list()
io$basedir <- "/Users/ricard/data/NMT-seq_ESC"
io$outdir <- "/Users/ricard/gastrulation/metacc/local_coupling/comparison/ESC/out"
io$tss <- "/Users/ricard/data/mm10_regulation/promoters/TSS.bed"
io$in.sample_metadata <- paste0(io$basedir,"/sample_metadata.txt")
io$met.indir <- paste(io$basedir,"met/raw",sep="/")
io$acc.indir <- paste(io$basedir,"acc/raw",sep="/")

## Define options ##
opts <- list()

# Define window options
opts$up <- 2500
opts$window <- 150
opts$slide <- 50
opts$down <- 2500

# Define colors for the conditions
opts$colors <- c("2i"="#FFD700", "Serum"="#CD853F")

# Define which cells to use
opts$cells <- fread(io$in.sample_metadata) %>% 
  .[pass_accQC==T & pass_metQC==T & culture%in%c("Serum","2i"),sample] 
```

<!-- Load gene metadata -->
```{r}
tss <- fread(io$tss,stringsAsFactors=TRUE)[,c(1,2,3,6,4)] %>%
  setnames(c("chr","start","end","strand","ens_id")) %>%
  .[,chr:=as.factor(sub("chr","",chr))] %>%
  .[,TSS:=start] %>%
  .[,c("start","end"):=.(start-opts$up,end+opts$down)] %>%
  setkey(chr,start,end)
```

<!-- Load sample metadata -->
```{r}
sample_metadata <- fread(io$in.sample_metadata, stringsAsFactors=T) %>% 
  .[,c("sample","culture")] %>%
  .[sample%in%opts$cells]
```

<!-- Load methylation data -->
```{r load_data, echo=FALSE, include=FALSE}
met_dt <- loadMultipleMetData(io$met.indir, opts$cells, tss)
```

<!-- Load accessibility data -->
```{r}
acc_dt <- loadMultipleMetData(io$acc.indir, opts$cells, tss)
```

<!-- Merge data and sample metadata -->
```{r}
met_dt <- met_dt %>% merge(sample_metadata[,c("sample","culture")], by="sample")
acc_dt <- acc_dt %>% merge(sample_metadata[,c("sample","culture")], by="sample")
```

<!-- Overlap DNA methylation and DNA accessibility data with windows -->
```{r}
tmp <- seq(from=0-opts$up, to=0+opts$down-opts$window, by=opts$slide)
foo <- data.table(window_center=tmp+(opts$window/2), rel_start=tmp, rel_end=tmp+opts$window)
```

DNA methylation
```{r}
met_ov_dt <- foverlaps(
    x=foo %>% setkey(rel_start,rel_end),
    y=met_dt[,c("rel_start","rel_end"):=dist] %>% setkey(rel_start,rel_end)
  ) %>%
  .[,c("i.rel_start","i.rel_end","rel_start","rel_end"):=NULL] %>%
  .[,.(met.rate=mean(rate)), by=c("sample","ens_id","window_center","culture")] %>% droplevels()
```

DNA accessibility
```{r}
acc_ov_dt <- foverlaps(
    x=acc_dt[,c("rel_start","rel_end"):=dist] %>% setkey(rel_start,rel_end),
    y=foo %>% setkey(rel_start,rel_end),
    nomatch = 0
  ) %>%
  .[,c("i.rel_start","i.rel_end","rel_start","rel_end"):=NULL] %>%
  .[,.(acc.rate=mean(rate)), by=c("sample","ens_id","window_center","culture")] %>% droplevels()
```

Merge
```{r}
bar <- merge(
  met_ov_dt,
  acc_ov_dt,
  by = c("sample","ens_id","window_center","culture")
  # allow.cartesian = TRUE
)
```

<!-- Compute local correlations -->
```{r}
cor <- bar %>% .[,.(r=cor(x=met.rate, y=acc.rate, method="pearson", use="pairwise.complete.obs")), by=c("sample","window_center","culture")]
```

<!-- Plot -->
```{r}
p <- ggplot(cor,aes(x=window_center, y=r, color=culture, fill=culture)) +
  stat_summary(fun.data="mean_se", geom="ribbon", alpha=0.25) +
  stat_summary(geom="line") +
  geom_hline(yintercept=0, linetype="dashed", color="black", size=0.5) +
  ylab("Met/Acc Correlation") + xlab("Genomic distance from TSS (bp)") +
  scale_x_continuous(limits=c(-opts$up,opts$down)) +
  scale_fill_manual(values=opts$colors) +
  scale_color_manual(values=opts$colors) +
  # coord_cartesian(ylim=c(0.1,-0.35)) +
  guides(fill=FALSE, color=FALSE) +
  theme(
    axis.text.x = element_text(size=rel(1.1),colour="black"),
    axis.text.y = element_text(size=rel(1.1), colour="black"),
    axis.title.x = element_text(size=rel(1.2)),
    axis.title.y = element_text(size=rel(1.2)),
    legend.key = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.justification = "center",
    legend.key.width = unit(2.0,"line"),
    legend.key.height = unit(2.0,"line"),
    legend.title = element_blank(),
    legend.text = element_text(size=rel(1.3)),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  )
p

pdf(file=paste0(io$outdir,"/metacc_localcoupling_ESC.pdf"), width=5, height=3.5)
print(p)
dev.off()
```

