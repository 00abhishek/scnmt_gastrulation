
# Define settings 

```{r define_opts, echo=FALSE}
source("/Users/ricard/scnmt_gastrulation/met/variability/differential/metacc_boxplots/load_settings.R")
source("/Users/ricard/scnmt_gastrulation/met/variability/differential/metacc_boxplots/utils.R")

# Size of figures
opts$width = 10
opts$height = 5
```

# Load data

Load methylation data
```{r load_data, echo=FALSE, include=FALSE}
met_dt <- lapply(names(opts$met.annos), function(n) {
  fread(sprintf("%s/%s.tsv.gz",io$met_data_parsed,n)) %>% .[V1%in%opts$met_cells]
}) %>% rbindlist %>% setnames(c("id_met","id","anno","Nmet","Ntotal","rate"))
```

Load accessibility data
```{r load_data, echo=FALSE, include=FALSE}
acc_dt <- lapply(names(opts$acc.annos), function(n) {
  fread(sprintf("%s/%s.tsv.gz",io$acc_data_parsed,n)) %>% .[V1%in%opts$acc_cells]
}) %>% rbindlist %>% setnames(c("id_acc","id","anno","Nmet","Ntotal","rate"))
```

Rename annotations
```{r}
met_dt <- met_dt %>% 
  .[,anno:=stringr::str_replace_all(anno,opts$met.annos)] %>%
  .[,id:=stringr::str_replace_all(id,"_500","")]

acc_dt <- acc_dt %>% 
  .[,anno:=stringr::str_replace_all(anno,opts$acc.annos)]
```

# Load differential results

Mean
```{r}
diff.mu.dt <- names(opts$met.annos) %>% 
  map(~ fread(sprintf("%s/%s_mu.txt.gz", io$diff.dir, .))) %>%
  rbindlist %>% .[,mean_diff:=mean_B-mean_A] %>%
  .[,c("id","anno","mean_diff","mean_diff_tail_prob")] %>%
  setnames(c("id","anno","mean_diff","mean_prob")) %>%
  .[mean_diff<0 & mean_prob>=0.80] %>%
  .[,anno:=stringr::str_replace_all(anno,opts$met.annos)] %>%
  .[,id:=stringr::str_replace_all(id,"_500","")]
```

Overdispersion
```{r}
diff.disp.dt <- names(opts$met.annos) %>% 
  map(~ fread(sprintf("%s/%s_gamma.txt.gz", io$diff.dir, .))) %>%
  rbindlist %>% .[,disp_change:=disp_B-disp_A] %>%
  .[,c("id","anno","disp_change","disp_diff_tail_prob")] %>%
  setnames(c("id","anno","disp_diff","disp_prob")) %>%
  .[disp_prob>=0.70 & disp_diff>0] %>%
  .[,anno:=stringr::str_replace_all(anno,opts$met.annos)] %>%
  .[,id:=stringr::str_replace_all(id,"_500","")]
```

merge
```{r}
diff.dt <- merge(diff.mu.dt, diff.disp.dt, by=c("id","anno")) 
```

# Parse data

Subset features
```{r}
hits <- diff.dt[,foo:=paste(id,anno,sep="-")] %>% .$foo
met_dt <- met_dt %>% .[,foo:=paste(id,anno,sep="-")] %>% .[foo%in%hits] %>% .[,foo:=NULL]
acc_dt <- acc_dt %>% .[,foo:=paste(id,anno,sep="-")] %>% .[foo%in%hits] %>% .[,foo:=NULL]
```

Merge data with metadata
```{r merge}
acc_dt <- merge(acc_dt, sample_metadata, by="id_acc")
met_dt <- merge(met_dt, sample_metadata, by="id_met")
```


Filter by minimum number of measurements per cell
```{r}
opts$min.acc.observations <- 25
acc_dt <- acc_dt[,N:=.N, by=c("sample","stage_lineage","anno")] %>% .[N>=opts$min.acc.observations] %>% .[,N:=NULL]

opts$min.met.observations <- 25
met_dt <- met_dt[,N:=.N, by=c("sample","stage_lineage","anno")] %>% .[N>=opts$min.met.observations] %>% .[,N:=NULL]
```

# Plot 

Boxplots with accessibility rate per genomic context and stage_lineage

```{r}
to.plot.acc <- acc_dt %>%
  .[,.(rate=100*(sum(Nmet)/sum(Ntotal)), Nmet=sum(Nmet), N=sum(Ntotal)),by=c("sample","stage_lineage","anno")]# %>%
  # .[,stage_lineage:=factor(stage_lineage, levels=names(colors))]
```

```{r}
p <- ggplot(to.plot.acc, aes(x=stage_lineage, y=rate)) +
  geom_boxplot(aes(fill=stage_lineage), outlier.shape=NA, coef=1) +
  # scale_fill_manual(values=colors) +
  labs(x="", y="Accessibility (%)") +
  facet_wrap(~anno, nrow=1, scales="fixed") +
  # coord_cartesian(ylim=c(21,55)) +
  theme_bw() +
  guides(color=F, fill=F) +
  theme_pb() +
  theme(strip.background = element_rect(fill="#00BFC4"))
print(p)

# pdf(paste0(io$outdir,"/boxplots_acc2.pdf"), useDingbats = F, onefile = F, width=14, height=6)
# print(p)
# dev.off()
```

Boxplots with methylation rate per genomic context and stage_lineage

```{r}
to.plot.met <- met_dt %>%
  .[,.(rate=100*(sum(Nmet)/sum(Ntotal)), Nmet=sum(Nmet), N=sum(Ntotal)),by=c("sample","stage_lineage","anno")]# %>%
  # .[,stage_lineage:=factor(stage_lineage, levels=names(colors))]
```

```{r}
p <- ggplot(to.plot.met, aes(x=stage_lineage, y=rate)) +
  geom_boxplot(aes(fill=stage_lineage), outlier.shape=NA, coef=1) +
  # scale_fill_manual(values=colors) +
  labs(x="", y="Methylation (%)") +
  facet_wrap(~anno, nrow=1, scales="fixed") +
  # coord_cartesian(ylim=c(8,93)) +
  theme_bw() +
  guides(color=F, fill=F) +
  theme_pb() +
  theme(strip.background = element_rect(fill="#F37A71"))
print(p)

# pdf(paste0(io$outdir,"/boxplots_met2.pdf"), useDingbats = F, onefile = F, width=14, height=6)
# print(p)
# dev.off()
```
