---
title: "Gastrulation: heatmaps on accessibility data using putative transcription factor binding sites"

---

```{r load_modules, echo=FALSE, include=FALSE}
library(data.table)
library(purrr)
library(ggplot2)
library(pheatmap)
library(doParallel)
```



```{r define_opts, echo=FALSE, include=FALSE}

## Define I/O ##
io <- list()
io$data_dir <- "/bi/scratch/Stephen_Clark/gastrulation_data"
io$base_dir <- "/bi/group/reik/Stephen/github/gastrulation"
io$sample.metadata <- paste0(io$data_dir, "/sample_metadata.txt")
io$in.data <- paste0(io$data_dir, "/acc/parsed/peaks")


## Define options ##
opts <- list()

# Define which stage and lineages to look at 
# opts$stage_lineage <- c("E4.5_EPI","E5.5_EPI","E6.5_EPI")
opts$stage <- c("E4.5", "E5.5","E6.5","E7.5")
#opts$stage <- c("E7.5")
opts$lineage <- c("EPI", "PE", "VE", "PS", "Ectoderm", "Endoderm", "Mesoderm")
opts$KO_3b <- "not"

# Define which cells to use
opts$cells <- fread(io$sample.metadata) %>% .[,stage_lineage:=paste(stage,lineage,sep="_")] %>% 
  .[pass_accQC==T & stage%in%opts$stage & lineage %in% opts$lineage, id_acc]
  # .[pass_accQC==T & stage_lineage%in%opts$stage_lineage,id_acc]

# Define which chr to use
# opts$chr <- as.character(1:19)
# opts$chr <- paste0("chr",as.character(1:19))
#opts$chr <- c("chr1","chr2","chr3")

# Define filtering options
opts$min.weight <- 1
opts$min.coverage <- 0.2

# Window size
# opts$window_size <- 10000

# adjust rates by global rate?
opts$adjust <- TRUE
io$global_rates <- paste0(io$data_dir, "/acc/output/global_rates/global_rates.csv")

# impute missing values using the mean for that locus?
opts$mean_impute <- TRUE

# pick only the top variable sites based on beta binomial?
opts$filter_by_bb <- FALSE
opts$bb_cutoff <- 0.1 # include only the top x fraction
io$bb_file <- paste0(io$base_dir, "/acc/motifs/betabinomial_model/out/all_stages_motifs.csv")
# otherwise filter on raw variance
opts$var_cutoff <- 0.5 # keep only the top xx fraction

# filter annotations?
opts$filter_anno = FALSE
opts$anno_select = c("HOCOMOCOv10-CRX_MOUSE.H10MO.A", "jaspar2016-Pou5f1::Sox2-MA0142")

# split by annotation or not?
opts$split_by_anno <- TRUE

# mean rate accross loci?

opts$mean_rate <- FALSE
```

<!-- load metadata -->
```{r, include=FALSE}

# Sample metadata
# sample_metadata <- fread(io$sample.metadata) %>% .[id_met%in%opts$cells] %>% .[,stage_lineage:=paste(stage,lineage,sep="_")]
sample_metadata <- fread(io$sample.metadata)[,c("id_acc","stage","lineage")] %>% .[id_acc%in%opts$cells] %>%
  .[,stage_lineage:=paste(stage,lineage,sep="_")] %>% setnames("id_acc","sample")

# Load genomic coordinates
#mm10 <- fread("/Users/ricard/data/mm10_sequence/mm10.genome"); colnames(mm10) <- c("chr","length")
# mm10 <- mm10 %>% .[,chr:=substr(chr,4,nchar(chr))] %>% .[chr %in% opts$chr]
#mm10 <- mm10 %>% .[chr %in% opts$chr]

```


```{r, include=FALSE}
files <- dir(io$in.data, pattern=".tsv.gz", full=TRUE)
# remove empty files
files <- files[file.size(files)>100]

if (opts$filter_anno) files <- map(opts$anno_select, ~files[grep(., files)]) %>% unlist
```


<!-- Load, parse and filter data -->
```{r, include=FALSE}
if (opts$adjust) adj <- fread(io$global_rates) %>% setkey(sample) 

if (opts$filter_by_bb) {
  bb <- fread(io$bb_file) %>%
    .[order(rank)] %>%
    .[1:(.N*opts$bb_cutoff), id]
}

registerDoParallel(cores=detectCores())  
data <- foreach(i=files) %dopar% {
#data <- map(files, ~{
  
  dt <- fread(paste("zcat", i)) #%>%
    #setnames(c("sample", "id", "anno", "rate", "Nmet", "N")) 
 
  # filter by weight
  dt <- dt[N>=opts$min.weight]
  
  if (opts$filter_by_bb){
    dt <- setkey(dt, id) %>%
      .[id %in% bb]
  } else {
    var <- dt[, .(var=var(rate)), id] %>%
      .[!is.na(var)] %>%
      .[order(-rank(var))] %>%
      .[1:(.N*opts$var_cutoff), id]
    dt <- dt[id %in% var]
  }
  
    
  anno <- basename(i) %>% gsub(".tsv.gz", "", .)
  
  if (dt[, .N]==0) return(NULL)
  
  if (opts$adjust) {
    setkey(dt, sample)
    dt <- dt[, rate := as.double(rate)] %>%
      .[adj, rate := rate/i.global_rate]
  }
  
  total_cells <- dt[, length(unique(sample))]
  
    # filter by weight
    dt <- dt[N>=opts$min.weight] %>%
    # filter by number of cells
    .[, coverage := (.N)/total_cells, id] %>%
    .[coverage >= opts$min.coverage]
  
  if (dt[, .N]==0) return(NULL)
  
  if (opts$mean_rate){
  dt <- dt[, .(rate=mean(rate), id=anno), .(sample, anno)]
} 
  
  # mean impute only if not taking the mean accross sites
  if (opts$mean_impute & !opts$mean_rate){
    dt <- dcast(dt, sample~id, value.var="rate") %>%
      melt(id.vars="sample", variable.name="id", value.name="rate") %>%
      .[, mean_rate := mean(rate, na.rm=TRUE), id] %>%
      .[is.na(rate), rate:=mean_rate]
  }
  dt[, anno := anno]
  dt
  
# }) %>%
#   rbindlist()
}



if (opts$split_by_anno & !opts$mean_rate){
  data <- data
} else {
  data <- list(all_annotations=bind_rows(data))
}

    
    
# dcast to matrix
data <- map(data, dcast, id~sample, value.var="rate") %>%
  map(~as.data.frame(.) %>%
        tibble::column_to_rownames("id") %>%
        as.matrix()
      )

```


```{r}
col_anno <- sample_metadata[, .(sample, stage, lineage)] %>%
  as.data.frame() %>%
  tibble::column_to_rownames("sample")

data_cor <- map(data, cor)

annos <- basename(files) %>% gsub(".tsv.gz", "", .)

for (i in seq_along(data)) {
  pheatmap(data[[i]], annotation_col=col_anno, show_rownames=FALSE, show_colnames=FALSE, main=annos[i])
  pheatmap(data_cor[[i]], annotation_col=col_anno, show_rownames=FALSE, show_colnames=FALSE, main=annos[i])
}


```


