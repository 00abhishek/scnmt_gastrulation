---
title: "Gastrulation: profiles of DNA accessibility at TF motifs"
output: 
  BiocStyle::html_document: 
    fig_width: 10
    fig_height: 8
---

The idea here is to take a window around predefined positions in the genome and plot the accessibility levels stratifying by stage or lineage. We can do one of this plots for each cell, but to keep the plot uncluttered we are going to draw the average line with standard deviation that shows the variability between cells.

Here we use motif site annotations generated from position weight matrices.

```{r load_modules, echo=FALSE, include=FALSE}
library(data.table)
library(purrr)
library(ggplot2)
library(cowplot)
library(stringr)
library(doParallel)
source("/bi/group/reik/Stephen/gastrulation/fread_gz.R")
```

```{r}
f <- function(x) { return(data.frame(y=mean(x), ymin=mean(x)-sd(x), ymax=mean(x)+sd(x))) }

theme_pub <- function() {
  theme(
    plot.margin = unit(c(t=1,r=1,b=1,l=1), "cm"),
    plot.title = element_text(size=25,hjust=0.5),
    axis.text=element_text(size=16, colour="black"),
    axis.title.x=element_text(size=17, margin=margin(10,0,0,0)),
    axis.title.y=element_text(size=17, margin=margin(0,10,0,0)),
    axis.line = element_line(size=rel(1.0)),
    axis.ticks = element_line(size=rel(1.5), color="black"),
    legend.key = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal",
    # legend.key.size= unit(0.5, "cm"),
    legend.key.width=unit(1.2,"line"),
    legend.key.height=unit(1.0,"line"),
    legend.margin = margin(t=10, r=0, b=0, l=0, unit="pt"),
    legend.title = element_blank(),
    legend.text = element_text(size=17),
    panel.border=element_blank(),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    panel.background=element_blank()
  )
}
```

```{r define_options, echo=FALSE}

## I/O ##
io <- list()
if (grepl("ricard",Sys.info()['nodename'])) {
  io$basedir <- "/Users/ricard/data/gastrulation_all"
  io$outdir <- "/Users/ricard/gastrulation_all/acc/profiles/out"
} else {
  #stop()
   io$basedir <- "/bi/scratch/Stephen_Clark/gastrulation_data"
   io$outdir <- "/bi/group/reik/Stephen/gastrulation/acc/motifs/profiles/out"
   io$data.indir <- paste(io$basedir,"acc/raw/",sep="/")
}

io$data.indir <- paste(io$basedir,"acc/raw",sep="/")
io$in.sample_metadata <- paste0(io$basedir,"/sample_metadata.txt")
io$features.indir <- paste0(io$basedir,"/features/sjc/motifs/motifdb")

## Options ##
opts <- list()
opts$window_size <- 1000 # in bp
opts$tile <- 30          # window size to calculate accessibility rates 
opts$numb_cells_per_group = 10 # take a random sample of this many cells for each group

# Define which annotations to use and where to center the windows
# opts$annotations <- c(
#   "prom_2000_2000"="center"
#   # "prom_2000_2000_cgi"="center",
#   # "prom_2000_2000_noncgi"="center",
#   # "active_enhancers"="center",
#   # "super_enhancers"="center",
#   # "primed_enhancers"="center",
#   # "CTCF"="center",
#   # "p300"="center",
#   # "Nanog"="center",
#   # "Oct4"="center"
# )

opts$annotations = list.files(io$features.indir, pattern=".bed") %>% 
    str_replace(".bed", "")
names(opts$annotations) = opts$annotations
opts$annotations[1:length(opts$annotations)] = "center"

# Define stages and lineages
opts$stage_lineage <- c("E4.5", "E5.5","E6.5_late", "E7.5")

# Pseudobulk cells in the same stage_lineage?
opts$pseudobulk <- F

# Define which cells to use
opts$cells <- fread(io$in.sample_metadata) %>% 
  # .[,stage_lineage:=paste(stage,lineage,sep="_")] %>%
  .[,stage_lineage:=stage] %>%
  .[pass_accQC==T & stage_lineage%in%opts$stage_lineage & KO_3b=="not"] %>%
    split(by="stage") %>%
    map(~.[sample(min(opts$numb_cells_per_group, .N)), id_acc]) %>%  
            # subset to xx cells per stage
            
          
    unlist(use.names=FALSE)




```

```{r print_opts, echo=FALSE}
# cat(sprintf("- Cells: %s\n",paste(opts$cells,collapse=" ")))
# cat(sprintf("- Window size: %d\n",opts$window_size))
# cat(sprintf("- Tile: %d\n",opts$tile))
```

<!-- load sample metadata -->
```{r}
sample_metadata <- fread(io$in.sample_metadata) %>% .[id_acc%in%opts$cells] %>% 
  .[,c("id_acc","stage","lineage")] %>% setnames("id_acc","sample") %>%
  # .[,stage_lineage:=paste(stage,lineage,sep="_")]
  .[,stage_lineage:=stage]
```

<!-- Load genomic contexts and define windows -->
```{r load_features, echo=FALSE, include=FALSE}
anno_list <- list()
for (anno in names(opts$annotations)) {
  tmp <- fread(sprintf("%s/%s.bed",io$features.indir,anno))[,c(1,2,3,4,5,6)]
  colnames(tmp) <- c("chr","start","end","strand","id","anno")
  tmp <- tmp[complete.cases(tmp)]
  tmp[end<start, c("start", "end") := list(end, start)]
  
  # Define central position for the window approach
  if (opts$annotations[anno] == "start") {
    tmp <- rbind(tmp[strand=="+",.(chr,start,strand,id,anno)] %>% .[,center:=start] %>% .[,c("start"):=NULL], 
                 tmp[strand=="-",.(chr,end,strand,id,anno)] %>% .[,center:=end] %>% .[,c("end"):=NULL]) 
  }
  if (opts$annotations[anno] == "center") {
    stopifnot(all(tmp[,end] > tmp[,start]))
    tmp <- tmp[,.(chr,start,end,strand,id,anno)][,center:=round(end+start)/2][,c("start","end"):=NULL]
  }
  if (opts$annotations[anno] == "end") {
    tmp <- rbind(tmp[strand=="+",.(chr,end,strand,id,anno)][,center:=end][,c("end"):=NULL], 
                 tmp[strand=="-",.(chr,start,strand,id,anno)][,center:=start][,c("start"):=NULL])
  }
  anno_list[[anno]] <- tmp %>% .[, c("start","end") := list(center-opts$window_size,center+opts$window_size)]
}

# anno_df <- rbindlist(anno_list) %>% 
#   .[,c("anno","chr"):=list(as.factor(anno),as.factor(sub("chr","",chr)))] %>%
#   setkey(chr,start,end)
# rm(anno_list)
```

```{r load_acc, echo=FALSE, include=FALSE}


files <- dir(io$data.indir, pattern=paste(opts$cells, collapse="|"), full=TRUE)
cells <- basename(files) %>% sub(".tsv.gz", "", .)
acc_raw <- map2(files, cells,  ~fread_gz(.x, select=c(1:2, 5)) %>% .[,sample := .y]) %>%
    rbindlist() %>%
    setnames("pos", "start") %>%
    .[, end := start] %>%
    setkey(chr, start, end)



sample_metadata <- unique(sample_metadata)
setkey(sample_metadata, sample)

dir.create(io$outdir, recursive=TRUE)


acc_dt <- map(anno_list, ~{
    anno_name <- .[,unique(anno)]
    .[, chr := as.character(chr)]
    setkey(acc_raw, chr, start, end)
    setkey(., chr, start, end)
    dt <- foverlaps(acc_raw, ., nomatch=0L) %>%
        .[,dist:=ifelse(strand %in% c("+","*"),i.start-center,center-i.start)] %>%
        .[, dist:=opts$tile*round(dist/opts$tile)] %>%
        .[, .(rate=mean(rate), .N), .(dist,anno,sample)] %>%
        setkey(sample) %>%
        merge(sample_metadata[, .(sample, stage_lineage)] %>% setkey(sample)) %>%
        .[, .(rate=mean(rate), sd=sd(rate)), .(dist, anno, stage_lineage)]
    plot <- ggplot(dt, aes(dist, rate, colour=stage_lineage, fill=stage_lineage)) + 
        geom_line() + 
        geom_ribbon(aes(ymin=rate-sd, ymax=rate+sd), alpha=0.2, colour=NA) +
        ylim(0.1, 0.8) +
        ggtitle(anno_name)
    file_name <- paste0(io$outdir, "/", anno_name, ".pdf")
    save_plot(file_name, plot, base_height=6)
    print(plot)
    return(dt)        
}) 
acc_dt <- rbindlist(acc_dt)
fwrite(acc_dt, paste0(io$outdir, "/accessibility_at_motifs.csv"))
    
    
# acc_list <- list()
# # for (cell in opts$cells) {
# foreach (cell=opts$cells) %dopar% {
#   tmp <- fread_gz(sprintf("%s/%s.tsv.gz",io$data.indir,cell), select=c(1:2, 5)) %>%
#     setnames(c("chr","pos","rate")) %>% .[,sample:=cell] %>% .[,c("start","end"):=list(pos,pos)] %>% setnames("pos","bp") %>% setkey("chr","start","end") %>%
#     foverlaps(.,anno_df, nomatch=0) %>% .[, c("chr","i.start","i.end") := NULL] %>%
#     .[,dist:=ifelse(strand %in% c("+","*"),bp-center,center-bp)] %>% 
#     .[, dist:=opts$tile*round(dist/opts$tile)] %>%
#     .[,list(rate=mean(rate), n=.N),by=.(sample,id,dist,anno)]
#   acc_list[[cell]] <- tmp
# }
# acc <- rbindlist(acc_list) %>% merge(sample_metadata[,c("sample","stage_lineage")], by="sample")
#  rm(acc_list)
``` 




```{r define_windows}
# # use these plots to find TFs with high accessibility and define the windows
# # using an arbritary cutoff of acc>=50
# 
# # either first average acc over all loci (per TF)
# windows = to.plot[, .(mean = mean(mean)), .(dist, anno)] %>% 
#     .[mean >= 50, .(min = min(dist), max = max(dist)), anno] %>%
#       setkey(anno) %>%
#       merge(anno_df %>% setkey(anno)) %>%
#       .[, start := center + min] %>%
#       .[, end := end + min]
# 
# # # or do it separately for each locus (will need >100 cells for this i think)
# # windows = acc[, .(mean = mean(rate), .N), .(dist, anno, id)] %>%
# #     .[mean >= 50 & N >= 25, .(min = min(dist), max = max(dist)), .(anno, id)] %>%
# #     setkey(anno, id) %>%
# #     merge(anno_df %>% setkey(id, anno)) %>%
# #     .[, start := center + min] %>%
# #     .[, end := end + min]
# 
# 
# file = paste0(io$features.indir, "/filt/tf_windows.tsv")
# dirname(file) %>%
#     dir.create(recursive=TRUE, showWarnings=FALSE)
# fwrite(windows[, .(chr, start, end, strand, id, anno)], file, sep="\t")

```

